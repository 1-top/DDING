{% extends 'base.html' %}
{% load static %}

{% block link %}
    {% static 'css/dding.css' %}
{% endblock %}

{% block content %}
    <div id="map"></div>
    <div class="search-box">
        <div class="show-address">
            <p class="address"></p>
        </div>
        <form action="#" id="search-form">
            <input type="text" name="address" placeholder="어디에서 찾으세요?"/>
        </form>
    </div>
    <div class="form-container">
        <form action="" method="POST" class="report-form visually-hidden">
            <div>
                <h4>메뉴</h4>
                <div class="category-container">
                    <input type="radio" name="category" id="shaved-ice" value="shaved-ice" hidden>
                    <label for="shaved-ice"><img src="{% static 'images/shaved-ice.png' %}" alt=""></label>
                    <input type="radio" name="category" id="icecream" value="icecream" hidden>
                    <label for="icecream"><img src="{% static 'images/ice-cream.png' %}" alt=""></label>
                    <input type="radio" name="category" id="soda" value="soda" hidden>
                    <label for="soda"><img src="{% static 'images/soda.png' %}" alt=""></label>
                </div>
            </div>
            <div class="location-container">
                <h4>위치</h4>
                <input type="text" name="location" id="location" placeholder="위치를 검색해주세요">
            </div>
            <div>
                <h4>가게 이름</h4>
                <input type="text" name="storename" id="storename" placeholder="가게 이름을 입력해주세요">
            </div>
            <button type="submit"><img src="{% static 'images/right-arrow.png' %}" alt="" width="15" height="15">
                제보하기
            </button>
        </form>
        <div class="report-button-container">
            <div class="snowman visually-hidden">
                <img src="{% static 'images/snowman.png' %}" alt="" width="77">
            </div>
            <div class="igloo">
                <img src="{% static 'images/igloo.png' %}" alt="" width="123">
            </div>
        </div>
    </div>
    <script type="text/javascript"
            src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ key }}&libraries=services,clusterer,drawing"></script>
    <script>
        const mapContainer = document.getElementById('map');
        const mapOption = {
            center: new kakao.maps.LatLng(33.450701, 126.570667),
            level: 4
        };
        // 지도 생성
        const map = new kakao.maps.Map(mapContainer, mapOption);

        // 주소-좌표 변환 객체 생성
        const geocoder = new kakao.maps.services.Geocoder();

        window.addEventListener('load', () => {
            kakao.maps.load(() => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((position) => {
                        const {coords: {longitude: lng, latitude: lat}} = position
                        geocoder.coord2RegionCode(lng, lat, (result, status) => {
                            if (status === kakao.maps.services.Status.OK) {
                                pAddress = document.querySelector('.address')
                                pAddress.innerHTML = result[0].address_name;
                                console.log(result[0].address_name)
                            }
                        });
                        map.setCenter(new kakao.maps.LatLng(lat, lng))
                    });
                }
            })
        })

        // 위치 검색 후 이동

        const changeMapCenter = (address) => {
            geocoder.addressSearch(address, function (result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                    map.setCenter(coords);
                }
            });
        }

        const moveLocation = (e) => {
            e.preventDefault();
            let address = e.target.elements.address.value;
            changeMapCenter(address);
        }

        const searchForm = document.querySelector('#search-form');
        searchForm.addEventListener('submit', moveLocation);

        // 좌표 이동 시 상단 주소 변경

        kakao.maps.event.addListener(map, 'idle', function () {
            searchAddrFromCoords(map.getCenter(), displayCenterInfo);
        });

        function searchAddrFromCoords(coords, callback) {
            geocoder.coord2RegionCode(coords.getLng(), coords.getLat(), callback);
        }

        // 지도 중심 좌표에 대한 주소 정보를 표출하는 함수
        function displayCenterInfo(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                var infoDiv = document.querySelector('.address');

                for (var i = 0; i < result.length; i++) {
                    // 행정동의 region_type 값은 'H'
                    if (result[i].region_type === 'H') {
                        infoDiv.innerHTML = result[i].address_name;
                        break;
                    }
                }
            }
        }

        const reportForm = document.querySelector('.report-form');
        const snowman = document.querySelector('.snowman');
        const igloo = document.querySelector('.igloo');
        igloo.addEventListener('click', () => {
            if (reportForm.classList.contains('visually-hidden')) {
                reportForm.classList.remove('visually-hidden');
                snowman.classList.remove('visually-hidden');
            } else {
                reportForm.classList.add('visually-hidden');
                snowman.classList.add('visually-hidden');
            }
        });

    </script>
{% endblock %}

